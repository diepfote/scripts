#!/usr/bin/env bash

set -o pipefail  # propagate errors
set -u  # exit on undefined
set -e  # exit on non-zero return value
#set -f  # disable globbing/filename expansion
shopt -s failglob  # error on unexpaned globs


source ~/Documents/scripts/source-me/common-functions.sh
source ~/Documents/scripts/source-me/posix-compliant-shells.sh


[ "$(uname)" = Darwin ] && base_temp_dir="$(mktemp -d)" \
                        || base_temp_dir=~/Downloads

file=~/Documents/cheatsheets/"$1"
f_basename="$(basename "$file")"
extension="$(echo "$f_basename" | sed 's#.*\.##')"

if [ "$extension" = pdf ] || [ "$extension" = png ]  || \
   [ "$extension" = jpg ] || [ "$extension" = html ] || \
   [ "$extension" = gif ]; then

  if [ "$extension" = html ]; then
    temp_file="$base_temp_dir"/"$f_basename"
    trap "rm '""$temp_file""'" EXIT
    cp "$file" "$temp_file"

    call_browser "$temp_file"
    sleep 1
  else
    [ "$(uname)" = Darwin ] && open "$file" \
                            || xdg-open "$file"
  fi

else
  command=lessc
  num_args_to_remove=1
  if [ "$1" = '--edit' ]; then
    num_args_to_remove=2
    command=nvim
    filename="${@:$#}"  # last argument
    file=~/Documents/cheatsheets/"$filename"
  fi

  # remove '--edit' arg
  # remove 'filename' arg
  #
  set -- "${@:2:$(($#-$num_args_to_remove))}"

  [[ "$command" =~ vim ]] && "$command" "$@" "$file" \
                          || "$command" "$file"

fi
