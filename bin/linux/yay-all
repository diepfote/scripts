#!/usr/bin/env bash

set -o pipefail  # propagate errors
set -u  # exit on undefined
set -e  # exit on non-zero return value
#set -f  # disable globbing/filename expansion
shopt -s failglob  # error on unexpaned globs


source ~/Documents/scripts/source-me/posix-compliant-shells.sh
# shellcheck disable=SC1090
source ~/Documents/scripts/source-me/linux/posix-compliant-shells.sh


trap "set +x" EXIT

pkgs_with_saved_checksums=(libplist-git libimobiledevice-glue-git libimobiledevice-git firejail-git vscodium-bin yay)
_yay-update-based-on-checksum () {
  pkg_name="$1"
  if ! yay -Qu | grep "$pkg_name"; then
    return
  fi

  (cd "$yay_cache" && yay -G "$pkg_name")
  if  sed -r '/^pkg(ver|rel)=/d' "$yay_cache"/"$pkg_name"/PKGBUILD | sha256sum | grep -f "$yay_cache"/"$pkg_name"-PKGBUILD.sha256sum; then
    echo
    set -x
    yay --noconfirm -Sa "$pkg_name"
    set +x
  else
    set +x
    # shellcheck disable=SC1090
    source ~/Documents/scripts/source-me/colors.sh
    # shellcheck disable=SC2154
    echo -en "$RED"
    echo     "[!] checksums do not match."
    # shellcheck disable=SC2154
    echo -e "     Not updating automatically!$NC"
    exit 1
  fi
}

_yay-update-anything-else () {
  # e.g. ^$|pkg1|pkg2
  grep_pattern="$(for elem in "${pkgs_with_saved_checksums[@]}"; do echo -n "$elem|"; done | sed 's#|$## ; s#^#\^\$|#')"
  if yay -Qyyua | grep -vE "$grep_pattern"; then
    set -x
    # TODO list packages first
    local command
    command=(yay -Syua)
    while ! "${command[@]}"; do
      :
    done
    set +x
  fi
}

pacman_cmd=('sudo' 'pacman' '-Syu')

# update package info for listing
echo n | "${pacman_cmd[@]}" || :
pacman-get-required-by-for-upgradeable

set -x
while ! "${pacman_cmd[@]}" "$@"; do
  sleep 1
done

for pkg_name in "${pkgs_with_saved_checksums[@]}"; do
  _yay-update-based-on-checksum "$pkg_name"
done
_yay-update-anything-else

