#!/usr/bin/env bash

# all of these stem from https://www.shellcheck.net/wiki/
set -o pipefail  # propagate errors
set -u  # exit on undefined
set -e  # exit on non-zero return value
#set -f  # disable globbing/filename expansion
shopt -s failglob  # error on unexpaned globs
shopt -s inherit_errexit  # Bash disables set -e in command substitution by default; reverse this behavior

set -x
TMP_OUT_DIR='/data'
OUT_DIR=''
args=()
while [ $# -gt 0 ]; do
key="$1"
  case "$key" in
    -o)
    OUT_DIR="$2"
    shift 2
    ;;

    --)
    shift
    break
    ;;

    *)
    args+=("$1")
    shift
    ;;

  esac
done


cleanup() { podman rm -f "$name"; rm -r "$temp"; }
trap cleanup EXIT

name=safer_paperoni
podman run --name "$name" \
  --user 1000:1000 \
  --cap-drop=ALL \
  --security-opt no-new-privileges \
  --pids-limit=100 \
  -w "$PWD" \
  -v "$HOME":"$HOME" \
  -v /tmp:/tmp \
  localhost/paperoni "${args[@]}" -o "$TMP_OUT_DIR"

temp="$(mktemp -d)"
podman cp "$name":"$TMP_OUT_DIR" "$temp"/
mv "$temp$TMP_OUT_DIR"/*.epub "$OUT_DIR"

