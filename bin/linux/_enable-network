#!/usr/bin/env bash

set -o pipefail  # propagate errors
set -u  # exit on undefined
set -e  # exit on non-zero return value
#set -f  # disable globbing/filename expansion
shopt -s failglob  # error on unexpaned globs

source ~/Documents/scripts/source-me/posix-compliant-shells.sh
source ~/Documents/scripts/source-me/linux/posix-compliant-shells.sh

cleanup () {
  set +x
}

set -x
__restart_unit_if is-active 'wpa_supplicant@wlp4s0.service'
set -x
__restart_unit_if is-active 'dhcpcd@wlp4s0.service'
set -x
__restart_unit_if is-failed 'dhcpcd@wlp4s0.service'
set -x


# shellcheck disable=SC2154
if [ "$_vpn_systemd_unit" != None ]; then
  __stop_related_units_if_active "$_vpn_systemd_unit"
__restart_unit_if_inactive "$_vpn_systemd_unit"
fi
set -x


sleep 3

vpn_file="/tmp/tmp.ping-success"

counter=0
timeout=2
while ! ping -c 2 -W "$timeout" archlinux.org  >/dev/null 2>&1 ; do
  if [ "$counter" -gt 4 ]; then
    exit
  fi

  rm -f "$vpn_file"
  if [ "$_vpn_systemd_unit" != None ]; then
    sudo systemctl restart "$_vpn_systemd_unit"
    sleep .5
  fi

  ((counter=counter+1))
done

touch "$vpn_file"

sleep 1.5
refresh-i3status

