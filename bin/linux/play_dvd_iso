#!/usr/bin/env bash

set -o pipefail  # propagate errors
set -u  # exit on undefined
set -e  # exit on non-zero return value
#set -f  # disable globbing/filename expansion
shopt -s failglob  # error on unexpaned globs

source ~/Documents/scripts/source-me/common-functions.sh


mount_dir="$(mktemp -d)"
mkdir -p "$mount_dir"  # p flag to avoid errors if exists

dir="$(read_toml_setting ~/Documents/config/sync.conf movies)"
file="$dir/$1"

# check is in default movie directory
if [ ! -f "$file" ]; then
  file="$1"
fi

cleanup () {
  fusermount -u "$mount_dir"
  rm -r "$mount_dir"
  set +x
}
trap "cleanup" EXIT

fuseiso "$file" "$mount_dir"

if [ $# -lt 2 ]; then
  set -x
  /usr/bin/mpv "$mount_dir"
else
  set -x
  /usr/bin/vlc "$mount_dir"
fi


