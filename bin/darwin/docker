#!/usr/bin/env bash

# all of these stem from https://www.shellcheck.net/wiki/
set -o pipefail  # propagate errors
set -u  # exit on undefined
set -e  # exit on non-zero return value
#set -f  # disable globbing/filename expansion
shopt -s failglob  # error on unexpaned globs
shopt -s inherit_errexit  # Bash disables set -e in command substitution by default; reverse this behavior

set_docker_rm_args () {
  local FORCE=''
  while [ $# -gt 0 ]; do
  # check if forced `rm`
  key="$1"
    case "$key" in
      -f)
      shift
      FORCE=true
      ;;

      --)
      shift
      break
      ;;

      *)
      # keep
      save_args+=("$1")
      shift
      ;;
    esac
  done

  if [ -n "$FORCE" ]; then
    set -- "${save_args[@]}"
    save_args=()

    # check if user provided `-t n` option for forceful `rm`
    TIMEOUT_SET_BY_USER=''
    while [ $# -gt 0 ]; do
      key="$1"
        case "$key" in
          --)
          shift
          break
          ;;

          -t)
          TIMEOUT_SET_BY_USER=true
          save_args+=("$1")
          save_args+=("$2")
          shift 2
          # keep
          ;;

          *)
          # keep
          save_args+=("$1")
          shift
          ;;
      esac
    done

    if [ -z "$TIMEOUT_SET_BY_USER" ]; then
      # set timeout to 0 if the user did not provide a custom timeout (overrides default of `-t 10`)
      save_args+=(-f -t 0)
    fi
  fi
}

while [ $# -gt 0 ]; do
key="$1"
  case "$key" in
    rm)
    shift
    save_args+=(rm)
    set_docker_rm_args "$@"
    set -- "${save_args[@]}"
    break
    ;;

    -h|--help)
    _help
    exit 0
    ;;

    --)
    shift
    break
    ;;

    *)
    break
    ;;

  esac
done


limactl shell default docker "$@"

