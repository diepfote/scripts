#!/usr/bin/env bash

set -o pipefail  # propagate errors
set -u  # exit on undefined
set -e  # exit on non-zero return value
#set -f  # disable globbing/filename expansion
shopt -s failglob  # error on unexpaned globs

_help() {
cat <<EOF
USAGE: $(basename $0) [OPTS_TO_SED] PATTERN FILE
EOF
}

if [ $# -lt 2 ]; then
  _help
  exit
fi


filename="${*:$#}"  # last argument
pattern="${*:(($#-1)):1}"  # next to last argument

temp_dir="$(mktemp -d)"
# shellcheck disable=SC2064
trap "rm -rf $temp_dir " EXIT

temp_filename="$temp_dir"/"$(basename "$filename")"
cp "$filename" "$temp_filename"

# ${@:1:(($#-2))} all except last 2 arguments
sed -i "${@:1:(($#-2))}" "$pattern" "$temp_filename"  # all arguments passed to sed


git_additional_args=(--word-diff)
GIT_PAGER="${GIT_PAGER:-}"
if [[ "$GIT_PAGER" =~ delta.* ]]; then
  git_additional_args=()
fi
git diff --no-index "${git_additional_args[@]}"  --  "$filename" "$temp_filename"

